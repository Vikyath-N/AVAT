services:
  - type: pserv
    name: avat-database
    env: postgres
    databaseName: avat_prod
    ipAllowList: []  # Only accessible by other services in this project

  - type: redis
    name: avat-redis
    ipAllowList: []  # Only accessible by other services in this project

  - type: web
    name: avat-backend
    env: python
    plan: free
    buildCommand: |
      # Install Python dependencies (Render provides system packages in runtime)
      pip install --upgrade pip
      pip install -r requirements.txt

      # Build frontend
      cd frontend
      export NODE_ENV=production
      npm install -g pnpm@8.15.8
      pnpm install --no-frozen-lockfile
      pnpm run build

      # Copy frontend build to static directory
      cd ..
      mkdir -p static
      cp -r frontend/build/* static/

      # Create flag file to indicate build completion
      touch static/build-complete.flag
    startCommand: uvicorn backend.main:app --host 0.0.0.0 --port $PORT
    autoDeploy: true
    branch: main
    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: AVAT_DATA_DIR
        value: /opt/render/project/.data/pdfs
      - key: TZ
        value: UTC
      - key: DATABASE_URL
        fromService:
          type: pserv
          name: avat-database
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: avat-redis
          property: connectionString
    healthCheckPath: /api/v1/health

